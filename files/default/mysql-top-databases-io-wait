#!/bin/bash -eu
# Top databases by I/O wait time (overall) â€” canonical name
#
# Usage: mysql-top-databases-io-wait [OPTIONS]
#
# Options:
#   -n, --limit N         Number of databases to show (default: 10)
#   -h, --help            Show this help message

usage() {
    cat <<EOF
Usage: $0 [OPTIONS]

Options:
  -n, --limit N         Number of databases to show (default: 10)
  -h, --help            Show this help message

Examples:
  $0                # top 10 databases overall by I/O wait time
  $0 --limit 5      # top 5 databases overall
EOF
}

LIMIT=10

# Translate long options to short options so we can use the builtin getopts
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --limit)
            ARGS+=('-n')
            ARGS+=("$2")
            shift 2
            ;;
        --help)
            ARGS+=('-h')
            shift
            ;;
        -n|-h)
            ARGS+=("$1")
            shift
            ;;
        --)
            ARGS+=("--")
            shift
            break
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${ARGS[@]}"

while getopts ':n:h' opt; do
    case "$opt" in
        n)
            LIMIT="$OPTARG"
            ;;
        h)
            usage
            exit 0
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            usage
            exit 2
            ;;
        ?)
            echo "Unknown option: -$OPTARG" >&2
            usage
            exit 2
            ;;
    esac
done

# Validate limit
if ! [[ "$LIMIT" =~ ^[0-9]+$ ]] || [[ "$LIMIT" -le 0 ]]; then
    echo "--limit must be a positive integer" >&2
    exit 2
fi

# Run query via here-doc; allow ${LIMIT} expansion
mysql <<EOF
SELECT
    table_schema AS database_name,
    SUM(io_read_latency) AS total_read_io_time,
    SUM(io_write_latency) AS total_write_io_time
FROM
    sys.schema_table_statistics
GROUP BY
    table_schema
ORDER BY
    SUM(io_read_latency + io_write_latency) DESC
LIMIT ${LIMIT};
EOF
